/*
 * This Java source file was generated by the Gradle 'init' task.
 */
package org.jaxos.app;

import com.google.protobuf.ByteString;
import org.jaxos.JaxosConfig;
import org.jaxos.algo.Communicator;
import org.jaxos.algo.Instance;
import org.jaxos.netty.NettyCommunicatorFactory;

import java.util.Date;

public class ClientApp {

    public static void main(String[] args) throws Exception {
        JaxosConfig config = new ArgumentParser().parse(args);
        ClientApp app = new ClientApp(config);
        app.run();
    }


    private JaxosConfig config;
    private Communicator communicator;

    public ClientApp(JaxosConfig config) {
        this.config = config;
    }

    public void run() throws Exception {
        Instance instance = new Instance(config, () -> communicator);
        NettyCommunicatorFactory factory = new NettyCommunicatorFactory(config, instance);

        this.communicator = factory.createCommunicator();

        final int n = 3;
        for(int i = 0; i < n; i++) {
            ByteString s =  ByteString.copyFromUtf8(new Date().toString());
            long i0 = instance.lastChosenInstance();
            instance.propose(s);

            //while(instance.lastChosenInstance() <= i0){
                Thread.sleep(1000);
            //}
        }
        Thread.sleep(1000);

        //double t = (double)proposal.taskElapsedMillis();
        //System.out.println("Average time is " + t/(n-0));
        this.communicator.close();
    }
}
